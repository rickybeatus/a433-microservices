version: 2.1

# executors:
#   docker:
#     docker:
#       - image: docker:stable
  # docker-publisher: 
  #   environment:
  #     IMAGE_NAME: ghcr.io/rickybeatus/karsajobs
  #   docker: 
  #     - image: circleci/golang:1.15
  #       auth:
  #         username: $DOCKER_USERNAME
  #         password: $DOCKER_PASSWORD

jobs:
  lint:
    docker:
      - image: docker:stable
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Run hadolint
          command: docker run --rm --interactive hadolint/hadolint < Dockerfile
  test:
    docker:
      - image: circleci/golang:1.15
    working_directory: /go/src/github.com/dicodingacademy/karsajobs
    steps:
      - checkout
      - run: 
          name: test-app
          command: go test -v -short --count=1 $(go list ./...)
  pushImage:
    # executor: docker-publisher
    docker:
      - image: circleci/golang:1.15
    working_directory: /go/src/github.com/dicodingacademy/karsajobs
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Publish Docker Image
          command: |
            echo $DOCKER_PASSWORD
            echo $DOCKER_USERNAME
            # docker build -t karsajobs2:latest .
            # docker tag karsajobs2:latest ghcr.io/rickybeatus/karsajobs2
            # echo â€œ$DOCKER_PASSWORD | docker login ghcr.io -u rickybeatus --password-stdin
            # docker push ghcr.io/rickybeatus/karsajobs2

workflows:
  lint_test:
    jobs:
      - lint
      - test  
      - pushImage
